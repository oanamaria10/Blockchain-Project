{"ast":null,"code":"import http from \"http\";\nimport https from \"https\";\nimport { gunzipSync } from \"zlib\";\nimport { assert, makeError } from \"./errors.js\";\nimport { getBytes } from \"./data.js\";\n/**\n *  @_ignore:\n */\nexport function createGetUrl(options) {\n  async function getUrl(req, signal) {\n    // Make sure we weren't cancelled before sending\n    assert(signal == null || !signal.cancelled, \"request cancelled before sending\", \"CANCELLED\");\n    const protocol = req.url.split(\":\")[0].toLowerCase();\n    assert(protocol === \"http\" || protocol === \"https\", `unsupported protocol ${protocol}`, \"UNSUPPORTED_OPERATION\", {\n      info: {\n        protocol\n      },\n      operation: \"request\"\n    });\n    assert(protocol === \"https\" || !req.credentials || req.allowInsecureAuthentication, \"insecure authorized connections unsupported\", \"UNSUPPORTED_OPERATION\", {\n      operation: \"request\"\n    });\n    const method = req.method;\n    const headers = Object.assign({}, req.headers);\n    const reqOptions = {\n      method,\n      headers\n    };\n    if (options) {\n      if (options.agent) {\n        reqOptions.agent = options.agent;\n      }\n    }\n    // Create a Node-specific AbortController, if available\n    let abort = null;\n    try {\n      abort = new AbortController();\n      reqOptions.abort = abort.signal;\n    } catch (e) {\n      console.log(e);\n    }\n    const request = (protocol === \"http\" ? http : https).request(req.url, reqOptions);\n    request.setTimeout(req.timeout);\n    const body = req.body;\n    if (body) {\n      request.write(Buffer.from(body));\n    }\n    request.end();\n    return new Promise((resolve, reject) => {\n      if (signal) {\n        signal.addListener(() => {\n          if (abort) {\n            abort.abort();\n          }\n          reject(makeError(\"request cancelled\", \"CANCELLED\"));\n        });\n      }\n      request.on(\"timeout\", () => {\n        reject(makeError(\"request timeout\", \"TIMEOUT\"));\n      });\n      request.once(\"response\", resp => {\n        const statusCode = resp.statusCode || 0;\n        const statusMessage = resp.statusMessage || \"\";\n        const headers = Object.keys(resp.headers || {}).reduce((accum, name) => {\n          let value = resp.headers[name] || \"\";\n          if (Array.isArray(value)) {\n            value = value.join(\", \");\n          }\n          accum[name] = value;\n          return accum;\n        }, {});\n        let body = null;\n        //resp.setEncoding(\"utf8\");\n        resp.on(\"data\", chunk => {\n          if (signal) {\n            try {\n              signal.checkSignal();\n            } catch (error) {\n              return reject(error);\n            }\n          }\n          if (body == null) {\n            body = chunk;\n          } else {\n            const newBody = new Uint8Array(body.length + chunk.length);\n            newBody.set(body, 0);\n            newBody.set(chunk, body.length);\n            body = newBody;\n          }\n        });\n        resp.on(\"end\", () => {\n          if (headers[\"content-encoding\"] === \"gzip\" && body) {\n            body = getBytes(gunzipSync(body));\n          }\n          resolve({\n            statusCode,\n            statusMessage,\n            headers,\n            body\n          });\n        });\n        resp.on(\"error\", error => {\n          //@TODO: Should this just return nornal response with a server error?\n          error.response = {\n            statusCode,\n            statusMessage,\n            headers,\n            body\n          };\n          reject(error);\n        });\n      });\n      request.on(\"error\", error => {\n        reject(error);\n      });\n    });\n  }\n  return getUrl;\n}\n// @TODO: remove in v7; provided for backwards compat\nconst defaultGetUrl = createGetUrl({});\n/**\n *  @_ignore:\n */\nexport async function getUrl(req, signal) {\n  return defaultGetUrl(req, signal);\n}","map":{"version":3,"names":["http","https","gunzipSync","assert","makeError","getBytes","createGetUrl","options","getUrl","req","signal","cancelled","protocol","url","split","toLowerCase","info","operation","credentials","allowInsecureAuthentication","method","headers","Object","assign","reqOptions","agent","abort","AbortController","e","console","log","request","setTimeout","timeout","body","write","Buffer","from","end","Promise","resolve","reject","addListener","on","once","resp","statusCode","statusMessage","keys","reduce","accum","name","value","Array","isArray","join","chunk","checkSignal","error","newBody","Uint8Array","length","set","response","defaultGetUrl"],"sources":["../../src.ts/utils/geturl.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}