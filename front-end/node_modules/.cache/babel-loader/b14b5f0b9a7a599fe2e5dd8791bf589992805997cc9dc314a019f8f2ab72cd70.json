{"ast":null,"code":"import * as ucanto from '@ucanto/core';\nimport * as API from './types.js';\nimport { canDelegateAbility } from '@web3-storage/capabilities/utils';\n/**\n *\n * @param {API.Delegation} delegation\n */\nexport function isExpired(delegation) {\n  if (delegation.expiration === undefined || delegation.expiration <= Math.floor(Date.now() / 1000)) {\n    return true;\n  }\n  return false;\n}\n/**\n *\n * @param {API.Delegation} delegation\n */\nexport function isTooEarly(delegation) {\n  if (!delegation.notBefore) {\n    return false;\n  }\n  return delegation.notBefore > Math.floor(Date.now() / 1000);\n}\n/**\n *\n * @param {API.Delegation} delegation\n * @param {object} [opts]\n * @param {API.Principal} [opts.checkAudience]\n * @param {boolean} [opts.checkIsExpired]\n * @param {boolean} [opts.checkIsTooEarly]\n */\nexport function validate(delegation, opts) {\n  const {\n    checkAudience,\n    checkIsExpired = true,\n    checkIsTooEarly = true\n  } = opts ?? {};\n  if (checkAudience && delegation.audience.did() !== checkAudience.did()) {\n    throw new Error(`Delegation audience ${delegation.audience.did()} does not match required DID ${checkAudience.did()}`);\n  }\n  if (checkIsExpired && isExpired(delegation)) {\n    throw new Error(`Delegation expired.`);\n  }\n  if (checkIsTooEarly && isTooEarly(delegation)) {\n    throw new Error(`Delegation is not active yet (too early).`);\n  }\n}\n/**\n * Returns true if the delegation includes capability been queried.\n *\n * @param {API.Delegation} delegation\n * @param {API.CapabilityQuery} capability\n */\nexport function canDelegateCapability(delegation, capability) {\n  const allowsCapabilities = ucanto.Delegation.allows(delegation);\n  for (const [uri, abilities] of Object.entries(allowsCapabilities)) {\n    if (matchResource( /** @type {API.Resource} */uri, capability.with)) {\n      const cans = /** @type {API.Ability[]} */Object.keys(abilities);\n      for (const can of cans) {\n        if (canDelegateAbility(can, capability.can)) {\n          return true;\n        }\n      }\n    }\n  }\n  return false;\n}\n/**\n * Returns true if given `resource` matches the resource query per UCAN\n * specification.\n *\n * @param {API.Resource} resource\n * @param {API.ResourceQuery} query\n */\nexport const matchResource = (resource, query) => {\n  if (query === 'ucan:*') {\n    return true;\n  } else if (typeof query === 'string') {\n    return resource === query;\n  } else {\n    return query.test(resource);\n  }\n};","map":{"version":3,"names":["ucanto","API","canDelegateAbility","isExpired","delegation","expiration","undefined","Math","floor","Date","now","isTooEarly","notBefore","validate","opts","checkAudience","checkIsExpired","checkIsTooEarly","audience","did","Error","canDelegateCapability","capability","allowsCapabilities","Delegation","allows","uri","abilities","Object","entries","matchResource","with","cans","keys","can","resource","query","test"],"sources":["../../src/delegations.js"],"sourcesContent":[null],"mappings":"AAAA,OAAO,KAAKA,MAAM,MAAM,cAAc;AACtC,OAAO,KAAKC,GAAG,MAAM,YAAY;AACjC,SAASC,kBAAkB,QAAQ,kCAAkC;AAErE;;;;AAIA,OAAM,SAAUC,SAASA,CAACC,UAAU;EAClC,IACEA,UAAU,CAACC,UAAU,KAAKC,SAAS,IACnCF,UAAU,CAACC,UAAU,IAAIE,IAAI,CAACC,KAAK,CAACC,IAAI,CAACC,GAAG,EAAE,GAAG,IAAI,CAAC,EACtD;IACA,OAAO,IAAI;;EAEb,OAAO,KAAK;AACd;AAEA;;;;AAIA,OAAM,SAAUC,UAAUA,CAACP,UAAU;EACnC,IAAI,CAACA,UAAU,CAACQ,SAAS,EAAE;IACzB,OAAO,KAAK;;EAEd,OAAOR,UAAU,CAACQ,SAAS,GAAGL,IAAI,CAACC,KAAK,CAACC,IAAI,CAACC,GAAG,EAAE,GAAG,IAAI,CAAC;AAC7D;AAEA;;;;;;;;AAQA,OAAM,SAAUG,QAAQA,CAACT,UAAU,EAAEU,IAAI;EACvC,MAAM;IACJC,aAAa;IACbC,cAAc,GAAG,IAAI;IACrBC,eAAe,GAAG;EAAI,CACvB,GAAGH,IAAI,IAAI,EAAE;EAEd,IAAIC,aAAa,IAAIX,UAAU,CAACc,QAAQ,CAACC,GAAG,EAAE,KAAKJ,aAAa,CAACI,GAAG,EAAE,EAAE;IACtE,MAAM,IAAIC,KAAK,CACb,uBAAuBhB,UAAU,CAACc,QAAQ,CAACC,GAAG,EAAE,gCAAgCJ,aAAa,CAACI,GAAG,EAAE,EAAE,CACtG;;EAGH,IAAIH,cAAc,IAAIb,SAAS,CAACC,UAAU,CAAC,EAAE;IAC3C,MAAM,IAAIgB,KAAK,CAAC,qBAAqB,CAAC;;EAGxC,IAAIH,eAAe,IAAIN,UAAU,CAACP,UAAU,CAAC,EAAE;IAC7C,MAAM,IAAIgB,KAAK,CAAC,2CAA2C,CAAC;;AAEhE;AAEA;;;;;;AAMA,OAAM,SAAUC,qBAAqBA,CAACjB,UAAU,EAAEkB,UAAU;EAC1D,MAAMC,kBAAkB,GAAGvB,MAAM,CAACwB,UAAU,CAACC,MAAM,CAACrB,UAAU,CAAC;EAC/D,KAAK,MAAM,CAACsB,GAAG,EAAEC,SAAS,CAAC,IAAIC,MAAM,CAACC,OAAO,CAACN,kBAAkB,CAAC,EAAE;IACjE,IAAIO,aAAa,EAAC,2BAA6BJ,GAAG,EAAGJ,UAAU,CAACS,IAAI,CAAC,EAAE;MACrE,MAAMC,IAAI,GAAG,4BAA8BJ,MAAM,CAACK,IAAI,CAACN,SAAS,CAAE;MAElE,KAAK,MAAMO,GAAG,IAAIF,IAAI,EAAE;QACtB,IAAI9B,kBAAkB,CAACgC,GAAG,EAAEZ,UAAU,CAACY,GAAG,CAAC,EAAE;UAC3C,OAAO,IAAI;;;;;EAKnB,OAAO,KAAK;AACd;AAEA;;;;;;;AAOA,OAAO,MAAMJ,aAAa,GAAGA,CAACK,QAAQ,EAAEC,KAAK,KAAI;EAC/C,IAAIA,KAAK,KAAK,QAAQ,EAAE;IACtB,OAAO,IAAI;GACZ,MAAM,IAAI,OAAOA,KAAK,KAAK,QAAQ,EAAE;IACpC,OAAOD,QAAQ,KAAKC,KAAK;GAC1B,MAAM;IACL,OAAOA,KAAK,CAACC,IAAI,CAACF,QAAQ,CAAC;;AAE/B,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}