{"ast":null,"code":"import * as UploadCapabilities from '@web3-storage/capabilities/upload';\nimport { SpaceDID } from '@web3-storage/capabilities/utils';\nimport retry from 'p-retry';\nimport { servicePrincipal, connection } from '../service.js';\nimport { REQUEST_RETRIES } from '../constants.js';\n/**\n * Register an \"upload\" with the service. The issuer needs the `upload/add`\n * delegated capability.\n *\n * Required delegated capability proofs: `upload/add`\n *\n * @param {import('../types.js').InvocationConfig} conf Configuration\n * for the UCAN invocation. An object with `issuer`, `with` and `proofs`.\n *\n * The `issuer` is the signing authority that is issuing the UCAN\n * invocation(s). It is typically the user _agent_.\n *\n * The `with` is the resource the invocation applies to. It is typically the\n * DID of a space.\n *\n * The `proofs` are a set of capability delegations that prove the issuer\n * has the capability to perform the action.\n *\n * The issuer needs the `upload/add` delegated capability.\n * @param {import('multiformats/link').UnknownLink} root Root data CID for the DAG that was stored.\n * @param {import('../types.js').CARLink[]} shards CIDs of CAR files that contain the DAG.\n * @param {import('../types.js').RequestOptions} [options]\n * @returns {Promise<import('../types.js').UploadAddSuccess>}\n */\nexport async function add({\n  issuer,\n  with: resource,\n  proofs,\n  audience\n}, root, shards, options = {}) {\n  /* c8 ignore next */\n  const conn = options.connection ?? connection;\n  const result = await retry(async () => {\n    return await UploadCapabilities.add.invoke({\n      issuer,\n      /* c8 ignore next */\n      audience: audience ?? servicePrincipal,\n      with: SpaceDID.from(resource),\n      nb: input(root, shards),\n      proofs,\n      nonce: options.nonce\n    }).execute(conn);\n  }, {\n    onFailedAttempt: console.warn,\n    retries: options.retries ?? REQUEST_RETRIES\n  });\n  if (!result.out.ok) {\n    throw new Error(`failed ${UploadCapabilities.add.can} invocation`, {\n      cause: result.out.error\n    });\n  }\n  return result.out.ok;\n}\n/** Returns the ability used by an invocation. */\nexport const ability = UploadCapabilities.add.can;\n/**\n * Returns required input to the invocation.\n *\n * @param {import('multiformats/link').UnknownLink} root\n * @param {import('../types.js').CARLink[]} shards\n */\nexport const input = (root, shards) => ({\n  root,\n  shards\n});","map":{"version":3,"names":["UploadCapabilities","SpaceDID","retry","servicePrincipal","connection","REQUEST_RETRIES","add","issuer","with","resource","proofs","audience","root","shards","options","conn","result","invoke","from","nb","input","nonce","execute","onFailedAttempt","console","warn","retries","out","ok","Error","can","cause","error","ability"],"sources":["../../../src/upload/add.js"],"sourcesContent":[null],"mappings":"AAAA,OAAO,KAAKA,kBAAkB,MAAM,mCAAmC;AACvE,SAASC,QAAQ,QAAQ,kCAAkC;AAC3D,OAAOC,KAAK,MAAM,SAAS;AAC3B,SAASC,gBAAgB,EAAEC,UAAU,QAAQ,eAAe;AAC5D,SAASC,eAAe,QAAQ,iBAAiB;AAEjD;;;;;;;;;;;;;;;;;;;;;;;;AAwBA,OAAO,eAAeC,GAAGA,CACvB;EAAEC,MAAM;EAAEC,IAAI,EAAEC,QAAQ;EAAEC,MAAM;EAAEC;AAAQ,CAAE,EAC5CC,IAAI,EACJC,MAAM,EACNC,OAAO,GAAG,EAAE;EAEZ;EACA,MAAMC,IAAI,GAAGD,OAAO,CAACV,UAAU,IAAIA,UAAU;EAC7C,MAAMY,MAAM,GAAG,MAAMd,KAAK,CACxB,YAAW;IACT,OAAO,MAAMF,kBAAkB,CAACM,GAAG,CAChCW,MAAM,CAAC;MACNV,MAAM;MACN;MACAI,QAAQ,EAAEA,QAAQ,IAAIR,gBAAgB;MACtCK,IAAI,EAAEP,QAAQ,CAACiB,IAAI,CAACT,QAAQ,CAAC;MAC7BU,EAAE,EAAEC,KAAK,CAACR,IAAI,EAAEC,MAAM,CAAC;MACvBH,MAAM;MACNW,KAAK,EAAEP,OAAO,CAACO;KAChB,CAAC,CACDC,OAAO,CAACP,IAAI,CAAC;EAClB,CAAC,EACD;IACEQ,eAAe,EAAEC,OAAO,CAACC,IAAI;IAC7BC,OAAO,EAAEZ,OAAO,CAACY,OAAO,IAAIrB;GAC7B,CACF;EAED,IAAI,CAACW,MAAM,CAACW,GAAG,CAACC,EAAE,EAAE;IAClB,MAAM,IAAIC,KAAK,CAAC,UAAU7B,kBAAkB,CAACM,GAAG,CAACwB,GAAG,aAAa,EAAE;MACjEC,KAAK,EAAEf,MAAM,CAACW,GAAG,CAACK;KACnB,CAAC;;EAGJ,OAAOhB,MAAM,CAACW,GAAG,CAACC,EAAE;AACtB;AAEA;AACA,OAAO,MAAMK,OAAO,GAAGjC,kBAAkB,CAACM,GAAG,CAACwB,GAAG;AAEjD;;;;;;AAMA,OAAO,MAAMV,KAAK,GAAGA,CAACR,IAAI,EAAEC,MAAM,MAAM;EAAED,IAAI;EAAEC;AAAM,CAAE,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}